import json
import unittest

from rs.machine.handlers.default_choose import DefaultChooseHandler
from rs.machine.state import GameState

THROW_POTION_STATE = '{"available_commands":["choose","potion","proceed","key","click","wait","state"],"ready_for_command":true,"in_game":true,"game_state":{"choice_list":["potion","card"],"screen_type":"COMBAT_REWARD","screen_state":{"rewards":[{"potion":{"requires_target":true,"can_use":false,"can_discard":true,"name":"Fire Potion","id":"Fire Potion"},"reward_type":"POTION"},{"reward_type":"CARD"}]},"seed":1394488993359253936,"deck":[{"exhausts":false,"is_playable":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"ae3def7a-5301-4f8e-b2cc-1bfcafced896","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"is_playable":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"3474878d-c887-4a17-93e3-ca457e2c9678","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"is_playable":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"a9ac25fb-1282-48ae-8858-aa09021744a9","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"is_playable":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"2007def6-e1d9-42c2-8320-2f2435a90112","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"is_playable":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"fcdc09d6-d885-498f-9e30-2d28f519cc3f","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"8277d3e6-2862-44aa-862d-00136d7a9d27","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"1d8a2b8c-b5b0-4fc6-9bbf-f84cd8e552c6","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"e72988fa-bbc9-4db3-a363-f9a745f4cba0","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":false,"cost":2,"name":"Bash","id":"Bash","type":"ATTACK","ethereal":false,"uuid":"e395e4da-6d44-41e0-aef8-537411654182","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"is_playable":false,"cost":0,"name":"Anger","id":"Anger","type":"ATTACK","ethereal":false,"uuid":"07c8a6db-86cf-48a0-9668-8d248a01c9fb","upgrades":0,"rarity":"COMMON","has_target":true},{"exhausts":false,"is_playable":false,"cost":2,"name":"Heavy Blade","id":"Heavy Blade","type":"ATTACK","ethereal":false,"uuid":"32a985a8-ee36-4ccc-8426-3d5dac514bd8","upgrades":0,"rarity":"COMMON","has_target":true},{"exhausts":false,"is_playable":false,"cost":4,"name":"Blood for Blood","id":"Blood for Blood","type":"ATTACK","ethereal":false,"uuid":"d9a3655d-efc6-4f33-8ffa-f7789f492127","upgrades":0,"rarity":"UNCOMMON","has_target":true},{"exhausts":false,"is_playable":false,"cost":1,"name":"Cleave","id":"Cleave","type":"ATTACK","ethereal":false,"uuid":"ba29a9af-ec1a-4977-8b45-adb18da859c4","upgrades":0,"rarity":"COMMON","has_target":false},{"exhausts":false,"is_playable":false,"cost":0,"name":"Bloodletting","id":"Bloodletting","type":"SKILL","ethereal":false,"uuid":"fd0c66bb-a6c7-44a5-a05e-4c518aefa097","upgrades":0,"rarity":"UNCOMMON","has_target":false},{"exhausts":true,"is_playable":false,"cost":1,"name":"Pummel","id":"Pummel","type":"ATTACK","ethereal":false,"uuid":"3fb3b62d-50f0-452c-ae95-365617ca1ce9","upgrades":0,"rarity":"UNCOMMON","has_target":true}],"relics":[{"name":"Burning Blood","id":"Burning Blood","counter":-1},{"name":"Golden Idol","id":"Golden Idol","counter":-1},{"name":"Pear","id":"Pear","counter":-1},{"name":"Orichalcum","id":"Orichalcum","counter":-1},{"name":"Bronze Scales","id":"Bronze Scales","counter":-1}],"max_hp":90,"act_boss":"Slime Boss","gold":294,"action_phase":"WAITING_ON_USER","act":1,"screen_name":"COMBAT_REWARD","room_phase":"COMPLETE","is_screen_up":true,"potions":[{"requires_target":false,"can_use":false,"can_discard":true,"name":"Essence of Steel","id":"EssenceOfSteel"},{"requires_target":false,"can_use":false,"can_discard":true,"name":"Strength Potion","id":"Strength Potion"},{"requires_target":true,"can_use":false,"can_discard":true,"name":"Smoke Bomb","id":"SmokeBomb"}],"current_hp":39,"floor":12,"ascension_level":0,"class":"IRONCLAD","map":[{"symbol":"M","children":[{"x":1,"y":1}],"x":1,"y":0,"parents":[]},{"symbol":"M","children":[{"x":3,"y":1}],"x":3,"y":0,"parents":[]},{"symbol":"M","children":[{"x":4,"y":1}],"x":4,"y":0,"parents":[]},{"symbol":"M","children":[{"x":6,"y":1}],"x":5,"y":0,"parents":[]},{"symbol":"?","children":[{"x":0,"y":2}],"x":1,"y":1,"parents":[]},{"symbol":"M","children":[{"x":4,"y":2}],"x":3,"y":1,"parents":[]},{"symbol":"M","children":[{"x":4,"y":2}],"x":4,"y":1,"parents":[]},{"symbol":"M","children":[{"x":5,"y":2}],"x":6,"y":1,"parents":[]},{"symbol":"M","children":[{"x":0,"y":3}],"x":0,"y":2,"parents":[]},{"symbol":"$","children":[{"x":3,"y":3},{"x":5,"y":3}],"x":4,"y":2,"parents":[]},{"symbol":"M","children":[{"x":5,"y":3},{"x":6,"y":3}],"x":5,"y":2,"parents":[]},{"symbol":"M","children":[{"x":1,"y":4}],"x":0,"y":3,"parents":[]},{"symbol":"M","children":[{"x":2,"y":4}],"x":3,"y":3,"parents":[]},{"symbol":"?","children":[{"x":4,"y":4}],"x":5,"y":3,"parents":[]},{"symbol":"M","children":[{"x":6,"y":4}],"x":6,"y":3,"parents":[]},{"symbol":"M","children":[{"x":1,"y":5}],"x":1,"y":4,"parents":[]},{"symbol":"M","children":[{"x":3,"y":5}],"x":2,"y":4,"parents":[]},{"symbol":"M","children":[{"x":4,"y":5},{"x":5,"y":5}],"x":4,"y":4,"parents":[]},{"symbol":"M","children":[{"x":5,"y":5}],"x":6,"y":4,"parents":[]},{"symbol":"R","children":[{"x":1,"y":6}],"x":1,"y":5,"parents":[]},{"symbol":"M","children":[{"x":2,"y":6},{"x":4,"y":6}],"x":3,"y":5,"parents":[]},{"symbol":"$","children":[{"x":4,"y":6}],"x":4,"y":5,"parents":[]},{"symbol":"M","children":[{"x":4,"y":6},{"x":5,"y":6}],"x":5,"y":5,"parents":[]},{"symbol":"?","children":[{"x":2,"y":7}],"x":1,"y":6,"parents":[]},{"symbol":"?","children":[{"x":2,"y":7}],"x":2,"y":6,"parents":[]},{"symbol":"M","children":[{"x":3,"y":7},{"x":4,"y":7}],"x":4,"y":6,"parents":[]},{"symbol":"$","children":[{"x":5,"y":7}],"x":5,"y":6,"parents":[]},{"symbol":"E","children":[{"x":1,"y":8},{"x":3,"y":8}],"x":2,"y":7,"parents":[]},{"symbol":"E","children":[{"x":4,"y":8}],"x":3,"y":7,"parents":[]},{"symbol":"M","children":[{"x":5,"y":8}],"x":4,"y":7,"parents":[]},{"symbol":"E","children":[{"x":5,"y":8}],"x":5,"y":7,"parents":[]},{"symbol":"T","children":[{"x":1,"y":9}],"x":1,"y":8,"parents":[]},{"symbol":"T","children":[{"x":2,"y":9}],"x":3,"y":8,"parents":[]},{"symbol":"T","children":[{"x":4,"y":9}],"x":4,"y":8,"parents":[]},{"symbol":"T","children":[{"x":5,"y":9},{"x":6,"y":9}],"x":5,"y":8,"parents":[]},{"symbol":"R","children":[{"x":2,"y":10}],"x":1,"y":9,"parents":[]},{"symbol":"E","children":[{"x":3,"y":10}],"x":2,"y":9,"parents":[]},{"symbol":"?","children":[{"x":4,"y":10}],"x":4,"y":9,"parents":[]},{"symbol":"R","children":[{"x":4,"y":10}],"x":5,"y":9,"parents":[]},{"symbol":"M","children":[{"x":5,"y":10}],"x":6,"y":9,"parents":[]},{"symbol":"M","children":[{"x":1,"y":11}],"x":2,"y":10,"parents":[]},{"symbol":"R","children":[{"x":3,"y":11}],"x":3,"y":10,"parents":[]},{"symbol":"?","children":[{"x":3,"y":11}],"x":4,"y":10,"parents":[]},{"symbol":"R","children":[{"x":5,"y":11}],"x":5,"y":10,"parents":[]},{"symbol":"M","children":[{"x":2,"y":12}],"x":1,"y":11,"parents":[]},{"symbol":"M","children":[{"x":2,"y":12},{"x":3,"y":12}],"x":3,"y":11,"parents":[]},{"symbol":"?","children":[{"x":6,"y":12}],"x":5,"y":11,"parents":[]},{"symbol":"R","children":[{"x":1,"y":13},{"x":2,"y":13}],"x":2,"y":12,"parents":[]},{"symbol":"?","children":[{"x":4,"y":13}],"x":3,"y":12,"parents":[]},{"symbol":"R","children":[{"x":5,"y":13},{"x":6,"y":13}],"x":6,"y":12,"parents":[]},{"symbol":"?","children":[{"x":0,"y":14}],"x":1,"y":13,"parents":[]},{"symbol":"M","children":[{"x":2,"y":14}],"x":2,"y":13,"parents":[]},{"symbol":"?","children":[{"x":4,"y":14}],"x":4,"y":13,"parents":[]},{"symbol":"?","children":[{"x":5,"y":14}],"x":5,"y":13,"parents":[]},{"symbol":"M","children":[{"x":6,"y":14}],"x":6,"y":13,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":0,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":2,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":4,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":5,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":6,"y":14,"parents":[]}],"room_type":"MonsterRoom"}}'
CHOOSE_STATE = '{"available_commands":["choose","proceed","key","click","wait","state"],"ready_for_command":true,"in_game":true,"game_state":{"choice_list":["potion","card"],"screen_type":"COMBAT_REWARD","screen_state":{"rewards":[{"potion":{"requires_target":false,"can_use":false,"can_discard":true,"name":"Essence of Steel","id":"EssenceOfSteel"},"reward_type":"POTION"},{"reward_type":"CARD"}]},"seed":1394488993359253936,"deck":[{"exhausts":false,"is_playable":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"e285fc39-b5f5-491f-9f88-7b99a0140d12","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"is_playable":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"164c05a6-5063-4832-9ddb-b3cd61d186d2","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"is_playable":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"8e6452e8-1799-4141-888e-7f27afd4f659","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"is_playable":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"d3c9cac0-5ee1-4949-ab89-61b3f310e275","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"is_playable":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"ac361ffb-ee4c-429a-85df-de319d589a6c","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"21b01a28-6290-4bf7-9f93-3db27c772bae","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"ef0a1732-75a3-414f-9847-331e9f8d26f7","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"1be053ac-1f8e-4e6a-b9b0-74cc0c025de2","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":false,"cost":2,"name":"Bash","id":"Bash","type":"ATTACK","ethereal":false,"uuid":"956ad74a-998d-47af-8f8c-0bbd126245bd","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"is_playable":false,"cost":0,"name":"Anger","id":"Anger","type":"ATTACK","ethereal":false,"uuid":"a7859a30-0db9-43de-9a88-00be11d09a1b","upgrades":0,"rarity":"COMMON","has_target":true},{"exhausts":false,"is_playable":false,"cost":2,"name":"Heavy Blade","id":"Heavy Blade","type":"ATTACK","ethereal":false,"uuid":"5e59acbd-6b1a-4808-b0e2-09e6ffe01001","upgrades":0,"rarity":"COMMON","has_target":true}],"relics":[{"name":"Burning Blood","id":"Burning Blood","counter":-1},{"name":"Golden Idol","id":"Golden Idol","counter":-1}],"max_hp":80,"act_boss":"Slime Boss","gold":158,"action_phase":"WAITING_ON_USER","act":1,"screen_name":"COMBAT_REWARD","room_phase":"COMPLETE","is_screen_up":true,"potions":[{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"},{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"},{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"}],"current_hp":57,"floor":4,"ascension_level":0,"class":"IRONCLAD","map":[{"symbol":"M","children":[{"x":1,"y":1}],"x":1,"y":0,"parents":[]},{"symbol":"M","children":[{"x":3,"y":1}],"x":3,"y":0,"parents":[]},{"symbol":"M","children":[{"x":4,"y":1}],"x":4,"y":0,"parents":[]},{"symbol":"M","children":[{"x":6,"y":1}],"x":5,"y":0,"parents":[]},{"symbol":"?","children":[{"x":0,"y":2}],"x":1,"y":1,"parents":[]},{"symbol":"M","children":[{"x":4,"y":2}],"x":3,"y":1,"parents":[]},{"symbol":"M","children":[{"x":4,"y":2}],"x":4,"y":1,"parents":[]},{"symbol":"M","children":[{"x":5,"y":2}],"x":6,"y":1,"parents":[]},{"symbol":"M","children":[{"x":0,"y":3}],"x":0,"y":2,"parents":[]},{"symbol":"$","children":[{"x":3,"y":3},{"x":5,"y":3}],"x":4,"y":2,"parents":[]},{"symbol":"M","children":[{"x":5,"y":3},{"x":6,"y":3}],"x":5,"y":2,"parents":[]},{"symbol":"M","children":[{"x":1,"y":4}],"x":0,"y":3,"parents":[]},{"symbol":"M","children":[{"x":2,"y":4}],"x":3,"y":3,"parents":[]},{"symbol":"?","children":[{"x":4,"y":4}],"x":5,"y":3,"parents":[]},{"symbol":"M","children":[{"x":6,"y":4}],"x":6,"y":3,"parents":[]},{"symbol":"M","children":[{"x":1,"y":5}],"x":1,"y":4,"parents":[]},{"symbol":"M","children":[{"x":3,"y":5}],"x":2,"y":4,"parents":[]},{"symbol":"M","children":[{"x":4,"y":5},{"x":5,"y":5}],"x":4,"y":4,"parents":[]},{"symbol":"M","children":[{"x":5,"y":5}],"x":6,"y":4,"parents":[]},{"symbol":"R","children":[{"x":1,"y":6}],"x":1,"y":5,"parents":[]},{"symbol":"M","children":[{"x":2,"y":6},{"x":4,"y":6}],"x":3,"y":5,"parents":[]},{"symbol":"$","children":[{"x":4,"y":6}],"x":4,"y":5,"parents":[]},{"symbol":"M","children":[{"x":4,"y":6},{"x":5,"y":6}],"x":5,"y":5,"parents":[]},{"symbol":"?","children":[{"x":2,"y":7}],"x":1,"y":6,"parents":[]},{"symbol":"?","children":[{"x":2,"y":7}],"x":2,"y":6,"parents":[]},{"symbol":"M","children":[{"x":3,"y":7},{"x":4,"y":7}],"x":4,"y":6,"parents":[]},{"symbol":"$","children":[{"x":5,"y":7}],"x":5,"y":6,"parents":[]},{"symbol":"E","children":[{"x":1,"y":8},{"x":3,"y":8}],"x":2,"y":7,"parents":[]},{"symbol":"E","children":[{"x":4,"y":8}],"x":3,"y":7,"parents":[]},{"symbol":"M","children":[{"x":5,"y":8}],"x":4,"y":7,"parents":[]},{"symbol":"E","children":[{"x":5,"y":8}],"x":5,"y":7,"parents":[]},{"symbol":"T","children":[{"x":1,"y":9}],"x":1,"y":8,"parents":[]},{"symbol":"T","children":[{"x":2,"y":9}],"x":3,"y":8,"parents":[]},{"symbol":"T","children":[{"x":4,"y":9}],"x":4,"y":8,"parents":[]},{"symbol":"T","children":[{"x":5,"y":9},{"x":6,"y":9}],"x":5,"y":8,"parents":[]},{"symbol":"R","children":[{"x":2,"y":10}],"x":1,"y":9,"parents":[]},{"symbol":"E","children":[{"x":3,"y":10}],"x":2,"y":9,"parents":[]},{"symbol":"?","children":[{"x":4,"y":10}],"x":4,"y":9,"parents":[]},{"symbol":"R","children":[{"x":4,"y":10}],"x":5,"y":9,"parents":[]},{"symbol":"M","children":[{"x":5,"y":10}],"x":6,"y":9,"parents":[]},{"symbol":"M","children":[{"x":1,"y":11}],"x":2,"y":10,"parents":[]},{"symbol":"R","children":[{"x":3,"y":11}],"x":3,"y":10,"parents":[]},{"symbol":"?","children":[{"x":3,"y":11}],"x":4,"y":10,"parents":[]},{"symbol":"R","children":[{"x":5,"y":11}],"x":5,"y":10,"parents":[]},{"symbol":"M","children":[{"x":2,"y":12}],"x":1,"y":11,"parents":[]},{"symbol":"M","children":[{"x":2,"y":12},{"x":3,"y":12}],"x":3,"y":11,"parents":[]},{"symbol":"?","children":[{"x":6,"y":12}],"x":5,"y":11,"parents":[]},{"symbol":"R","children":[{"x":1,"y":13},{"x":2,"y":13}],"x":2,"y":12,"parents":[]},{"symbol":"?","children":[{"x":4,"y":13}],"x":3,"y":12,"parents":[]},{"symbol":"R","children":[{"x":5,"y":13},{"x":6,"y":13}],"x":6,"y":12,"parents":[]},{"symbol":"?","children":[{"x":0,"y":14}],"x":1,"y":13,"parents":[]},{"symbol":"M","children":[{"x":2,"y":14}],"x":2,"y":13,"parents":[]},{"symbol":"?","children":[{"x":4,"y":14}],"x":4,"y":13,"parents":[]},{"symbol":"?","children":[{"x":5,"y":14}],"x":5,"y":13,"parents":[]},{"symbol":"M","children":[{"x":6,"y":14}],"x":6,"y":13,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":0,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":2,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":4,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":5,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":6,"y":14,"parents":[]}],"room_type":"MonsterRoom"}}'


class ChooseHandlerTestCase(unittest.TestCase):
    def test_potion_chosen(self):
        handler = DefaultChooseHandler()
        state = GameState(json.loads(CHOOSE_STATE))
        self.assertEqual("choose 0", handler.handle(state))

    def test_potion_discarded_when_full(self):
        handler = DefaultChooseHandler()
        state = GameState(json.loads(THROW_POTION_STATE))
        self.assertEqual("potion discard 0", handler.handle(state))


if __name__ == '__main__':
    unittest.main()
