import json
import unittest

from rs.ai.requested_strike.handlers.path_handler import PathHandler
from rs.ai.requested_strike.handlers.smart_path_handler import SmartPathHandler
from rs.machine.state import GameState

INITIAL_STATE = '{"available_commands":["choose","return","key","click","wait","state"],"ready_for_command":true,"in_game":true,"game_state":{"choice_list":["x\u003d0","x\u003d3","x\u003d4","x\u003d6"],"screen_type":"MAP","screen_state":{"first_node_chosen":false,"current_node":{"x":0,"y":-1},"boss_available":false,"next_nodes":[{"symbol":"M","x":0,"y":0},{"symbol":"M","x":3,"y":0},{"symbol":"M","x":4,"y":0},{"symbol":"M","x":6,"y":0}]},"seed":5566331376563555765,"deck":[{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"6dd898c0-7b60-4039-9f1f-436ddf8ed4c4","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"0dfaaa2d-b20d-4f1b-9777-74da158f4590","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"ad74e908-d75b-45ac-a8e0-34e43f62651b","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"924b15ff-f99f-4bfa-959d-d6dac228b87a","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"910593c2-d6c5-4b16-ab74-c925c4be59dc","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"26f28065-33ca-4481-8417-91b3e0055e80","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"3f58fc30-385f-4d24-9a28-5392e0181578","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"b39f77c7-c5a5-44d9-b6e5-54814494bbd0","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"8b44ca8e-285b-44f9-8b50-0f7cbdc22f4d","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"cost":2,"name":"Bash","id":"Bash","type":"ATTACK","ethereal":false,"uuid":"12be1416-582a-479a-ba85-bf953e48618c","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":true,"cost":0,"name":"Purity","id":"Purity","type":"SKILL","ethereal":false,"uuid":"3ae21f6a-ea92-4300-a892-e9a0f0c5a2bf","upgrades":0,"rarity":"UNCOMMON","has_target":false}],"relics":[{"name":"Burning Blood","id":"Burning Blood","counter":-1}],"max_hp":80,"act_boss":"The Guardian","gold":99,"action_phase":"WAITING_ON_USER","act":1,"screen_name":"MAP","room_phase":"COMPLETE","is_screen_up":true,"potions":[{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"},{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"},{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"}],"current_hp":80,"floor":0,"ascension_level":0,"class":"IRONCLAD","map":[{"symbol":"M","children":[{"x":1,"y":1}],"x":0,"y":0,"parents":[]},{"symbol":"M","children":[{"x":3,"y":1}],"x":3,"y":0,"parents":[]},{"symbol":"M","children":[{"x":5,"y":1}],"x":4,"y":0,"parents":[]},{"symbol":"M","children":[{"x":6,"y":1}],"x":6,"y":0,"parents":[]},{"symbol":"M","children":[{"x":1,"y":2}],"x":1,"y":1,"parents":[]},{"symbol":"M","children":[{"x":4,"y":2}],"x":3,"y":1,"parents":[]},{"symbol":"M","children":[{"x":5,"y":2}],"x":5,"y":1,"parents":[]},{"symbol":"?","children":[{"x":5,"y":2}],"x":6,"y":1,"parents":[]},{"symbol":"?","children":[{"x":0,"y":3}],"x":1,"y":2,"parents":[]},{"symbol":"M","children":[{"x":3,"y":3}],"x":4,"y":2,"parents":[]},{"symbol":"$","children":[{"x":5,"y":3}],"x":5,"y":2,"parents":[]},{"symbol":"M","children":[{"x":1,"y":4}],"x":0,"y":3,"parents":[]},{"symbol":"?","children":[{"x":3,"y":4}],"x":3,"y":3,"parents":[]},{"symbol":"?","children":[{"x":4,"y":4},{"x":5,"y":4},{"x":6,"y":4}],"x":5,"y":3,"parents":[]},{"symbol":"?","children":[{"x":1,"y":5}],"x":1,"y":4,"parents":[]},{"symbol":"?","children":[{"x":2,"y":5},{"x":3,"y":5}],"x":3,"y":4,"parents":[]},{"symbol":"?","children":[{"x":3,"y":5}],"x":4,"y":4,"parents":[]},{"symbol":"M","children":[{"x":5,"y":5}],"x":5,"y":4,"parents":[]},{"symbol":"$","children":[{"x":6,"y":5}],"x":6,"y":4,"parents":[]},{"symbol":"R","children":[{"x":1,"y":6}],"x":1,"y":5,"parents":[]},{"symbol":"E","children":[{"x":2,"y":6}],"x":2,"y":5,"parents":[]},{"symbol":"R","children":[{"x":3,"y":6},{"x":4,"y":6}],"x":3,"y":5,"parents":[]},{"symbol":"E","children":[{"x":6,"y":6}],"x":5,"y":5,"parents":[]},{"symbol":"E","children":[{"x":6,"y":6}],"x":6,"y":5,"parents":[]},{"symbol":"?","children":[{"x":2,"y":7}],"x":1,"y":6,"parents":[]},{"symbol":"M","children":[{"x":2,"y":7}],"x":2,"y":6,"parents":[]},{"symbol":"E","children":[{"x":3,"y":7}],"x":3,"y":6,"parents":[]},{"symbol":"?","children":[{"x":5,"y":7}],"x":4,"y":6,"parents":[]},{"symbol":"M","children":[{"x":5,"y":7},{"x":6,"y":7}],"x":6,"y":6,"parents":[]},{"symbol":"R","children":[{"x":1,"y":8},{"x":2,"y":8}],"x":2,"y":7,"parents":[]},{"symbol":"R","children":[{"x":2,"y":8}],"x":3,"y":7,"parents":[]},{"symbol":"M","children":[{"x":4,"y":8},{"x":5,"y":8}],"x":5,"y":7,"parents":[]},{"symbol":"?","children":[{"x":5,"y":8}],"x":6,"y":7,"parents":[]},{"symbol":"T","children":[{"x":0,"y":9}],"x":1,"y":8,"parents":[]},{"symbol":"T","children":[{"x":3,"y":9}],"x":2,"y":8,"parents":[]},{"symbol":"T","children":[{"x":4,"y":9}],"x":4,"y":8,"parents":[]},{"symbol":"T","children":[{"x":4,"y":9},{"x":6,"y":9}],"x":5,"y":8,"parents":[]},{"symbol":"M","children":[{"x":1,"y":10}],"x":0,"y":9,"parents":[]},{"symbol":"M","children":[{"x":4,"y":10}],"x":3,"y":9,"parents":[]},{"symbol":"R","children":[{"x":4,"y":10}],"x":4,"y":9,"parents":[]},{"symbol":"M","children":[{"x":6,"y":10}],"x":6,"y":9,"parents":[]},{"symbol":"M","children":[{"x":0,"y":11}],"x":1,"y":10,"parents":[]},{"symbol":"E","children":[{"x":3,"y":11},{"x":4,"y":11},{"x":5,"y":11}],"x":4,"y":10,"parents":[]},{"symbol":"M","children":[{"x":6,"y":11}],"x":6,"y":10,"parents":[]},{"symbol":"M","children":[{"x":0,"y":12}],"x":0,"y":11,"parents":[]},{"symbol":"?","children":[{"x":3,"y":12}],"x":3,"y":11,"parents":[]},{"symbol":"M","children":[{"x":4,"y":12}],"x":4,"y":11,"parents":[]},{"symbol":"R","children":[{"x":6,"y":12}],"x":5,"y":11,"parents":[]},{"symbol":"$","children":[{"x":6,"y":12}],"x":6,"y":11,"parents":[]},{"symbol":"M","children":[{"x":1,"y":13}],"x":0,"y":12,"parents":[]},{"symbol":"M","children":[{"x":3,"y":13},{"x":4,"y":13}],"x":3,"y":12,"parents":[]},{"symbol":"?","children":[{"x":4,"y":13}],"x":4,"y":12,"parents":[]},{"symbol":"M","children":[{"x":5,"y":13},{"x":6,"y":13}],"x":6,"y":12,"parents":[]},{"symbol":"M","children":[{"x":1,"y":14}],"x":1,"y":13,"parents":[]},{"symbol":"?","children":[{"x":4,"y":14}],"x":3,"y":13,"parents":[]},{"symbol":"M","children":[{"x":4,"y":14},{"x":5,"y":14}],"x":4,"y":13,"parents":[]},{"symbol":"M","children":[{"x":5,"y":14}],"x":5,"y":13,"parents":[]},{"symbol":"M","children":[{"x":6,"y":14}],"x":6,"y":13,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":1,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":4,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":5,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":6,"y":14,"parents":[]}],"room_type":"NeowRoom"}}'
FLOOR_5ISH = '{"available_commands":["choose","potion","return","key","click","wait","state"],"ready_for_command":true,"in_game":true,"game_state":{"choice_list":["x\u003d4","x\u003d5","x\u003d6"],"screen_type":"MAP","screen_state":{"first_node_chosen":true,"current_node":{"symbol":"?","x":5,"y":3},"boss_available":false,"next_nodes":[{"symbol":"?","x":4,"y":4},{"symbol":"M","x":5,"y":4},{"symbol":"$","x":6,"y":4}]},"seed":5566331376563555765,"deck":[{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"7513f1b9-1955-4bb2-afd2-9213fb5785bc","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"0c6632ed-503d-4d16-ba41-8a431cb1e42c","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"02b37bf4-c13a-4f96-8a65-14e6afdba589","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"65e99c90-ff77-4ef0-ae01-483e12712c26","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"ca82639c-c442-44f6-ab36-94e68c062bb3","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"64a6a908-c0bc-4317-b30c-0b4b55e007c3","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"8fd88d05-6942-4338-9e24-b0ad24a2acaa","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"cost":2,"name":"Bash","id":"Bash","type":"ATTACK","ethereal":false,"uuid":"6e3698be-9901-45d6-b1db-9071fd2ecbb2","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":true,"cost":0,"name":"Purity","id":"Purity","type":"SKILL","ethereal":false,"uuid":"9f5e15cd-b379-4106-9725-8d81267dbda0","upgrades":0,"rarity":"UNCOMMON","has_target":false},{"exhausts":false,"cost":2,"name":"Perfected Strike","id":"Perfected Strike","type":"ATTACK","ethereal":false,"uuid":"c06e07c0-64ac-4f36-95b2-2b62707d5083","upgrades":0,"rarity":"COMMON","has_target":true}],"relics":[{"name":"Burning Blood","id":"Burning Blood","counter":-1}],"max_hp":80,"act_boss":"The Guardian","gold":56,"action_phase":"WAITING_ON_USER","act":1,"screen_name":"MAP","room_phase":"COMPLETE","is_screen_up":true,"potions":[{"requires_target":false,"can_use":false,"can_discard":true,"name":"Ancient Potion","id":"Ancient Potion"},{"requires_target":false,"can_use":false,"can_discard":true,"name":"Liquid Memories","id":"LiquidMemories"},{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"}],"current_hp":80,"floor":4,"ascension_level":0,"class":"IRONCLAD","map":[{"symbol":"M","children":[{"x":1,"y":1}],"x":0,"y":0,"parents":[]},{"symbol":"M","children":[{"x":3,"y":1}],"x":3,"y":0,"parents":[]},{"symbol":"M","children":[{"x":5,"y":1}],"x":4,"y":0,"parents":[]},{"symbol":"M","children":[{"x":6,"y":1}],"x":6,"y":0,"parents":[]},{"symbol":"M","children":[{"x":1,"y":2}],"x":1,"y":1,"parents":[]},{"symbol":"M","children":[{"x":4,"y":2}],"x":3,"y":1,"parents":[]},{"symbol":"M","children":[{"x":5,"y":2}],"x":5,"y":1,"parents":[]},{"symbol":"?","children":[{"x":5,"y":2}],"x":6,"y":1,"parents":[]},{"symbol":"?","children":[{"x":0,"y":3}],"x":1,"y":2,"parents":[]},{"symbol":"M","children":[{"x":3,"y":3}],"x":4,"y":2,"parents":[]},{"symbol":"$","children":[{"x":5,"y":3}],"x":5,"y":2,"parents":[]},{"symbol":"M","children":[{"x":1,"y":4}],"x":0,"y":3,"parents":[]},{"symbol":"?","children":[{"x":3,"y":4}],"x":3,"y":3,"parents":[]},{"symbol":"?","children":[{"x":4,"y":4},{"x":5,"y":4},{"x":6,"y":4}],"x":5,"y":3,"parents":[]},{"symbol":"?","children":[{"x":1,"y":5}],"x":1,"y":4,"parents":[]},{"symbol":"?","children":[{"x":2,"y":5},{"x":3,"y":5}],"x":3,"y":4,"parents":[]},{"symbol":"?","children":[{"x":3,"y":5}],"x":4,"y":4,"parents":[]},{"symbol":"M","children":[{"x":5,"y":5}],"x":5,"y":4,"parents":[]},{"symbol":"$","children":[{"x":6,"y":5}],"x":6,"y":4,"parents":[]},{"symbol":"R","children":[{"x":1,"y":6}],"x":1,"y":5,"parents":[]},{"symbol":"E","children":[{"x":2,"y":6}],"x":2,"y":5,"parents":[]},{"symbol":"R","children":[{"x":3,"y":6},{"x":4,"y":6}],"x":3,"y":5,"parents":[]},{"symbol":"E","children":[{"x":6,"y":6}],"x":5,"y":5,"parents":[]},{"symbol":"E","children":[{"x":6,"y":6}],"x":6,"y":5,"parents":[]},{"symbol":"?","children":[{"x":2,"y":7}],"x":1,"y":6,"parents":[]},{"symbol":"M","children":[{"x":2,"y":7}],"x":2,"y":6,"parents":[]},{"symbol":"E","children":[{"x":3,"y":7}],"x":3,"y":6,"parents":[]},{"symbol":"?","children":[{"x":5,"y":7}],"x":4,"y":6,"parents":[]},{"symbol":"M","children":[{"x":5,"y":7},{"x":6,"y":7}],"x":6,"y":6,"parents":[]},{"symbol":"R","children":[{"x":1,"y":8},{"x":2,"y":8}],"x":2,"y":7,"parents":[]},{"symbol":"R","children":[{"x":2,"y":8}],"x":3,"y":7,"parents":[]},{"symbol":"M","children":[{"x":4,"y":8},{"x":5,"y":8}],"x":5,"y":7,"parents":[]},{"symbol":"?","children":[{"x":5,"y":8}],"x":6,"y":7,"parents":[]},{"symbol":"T","children":[{"x":0,"y":9}],"x":1,"y":8,"parents":[]},{"symbol":"T","children":[{"x":3,"y":9}],"x":2,"y":8,"parents":[]},{"symbol":"T","children":[{"x":4,"y":9}],"x":4,"y":8,"parents":[]},{"symbol":"T","children":[{"x":4,"y":9},{"x":6,"y":9}],"x":5,"y":8,"parents":[]},{"symbol":"M","children":[{"x":1,"y":10}],"x":0,"y":9,"parents":[]},{"symbol":"M","children":[{"x":4,"y":10}],"x":3,"y":9,"parents":[]},{"symbol":"R","children":[{"x":4,"y":10}],"x":4,"y":9,"parents":[]},{"symbol":"M","children":[{"x":6,"y":10}],"x":6,"y":9,"parents":[]},{"symbol":"M","children":[{"x":0,"y":11}],"x":1,"y":10,"parents":[]},{"symbol":"E","children":[{"x":3,"y":11},{"x":4,"y":11},{"x":5,"y":11}],"x":4,"y":10,"parents":[]},{"symbol":"M","children":[{"x":6,"y":11}],"x":6,"y":10,"parents":[]},{"symbol":"M","children":[{"x":0,"y":12}],"x":0,"y":11,"parents":[]},{"symbol":"?","children":[{"x":3,"y":12}],"x":3,"y":11,"parents":[]},{"symbol":"M","children":[{"x":4,"y":12}],"x":4,"y":11,"parents":[]},{"symbol":"R","children":[{"x":6,"y":12}],"x":5,"y":11,"parents":[]},{"symbol":"$","children":[{"x":6,"y":12}],"x":6,"y":11,"parents":[]},{"symbol":"M","children":[{"x":1,"y":13}],"x":0,"y":12,"parents":[]},{"symbol":"M","children":[{"x":3,"y":13},{"x":4,"y":13}],"x":3,"y":12,"parents":[]},{"symbol":"?","children":[{"x":4,"y":13}],"x":4,"y":12,"parents":[]},{"symbol":"M","children":[{"x":5,"y":13},{"x":6,"y":13}],"x":6,"y":12,"parents":[]},{"symbol":"M","children":[{"x":1,"y":14}],"x":1,"y":13,"parents":[]},{"symbol":"?","children":[{"x":4,"y":14}],"x":3,"y":13,"parents":[]},{"symbol":"M","children":[{"x":4,"y":14},{"x":5,"y":14}],"x":4,"y":13,"parents":[]},{"symbol":"M","children":[{"x":5,"y":14}],"x":5,"y":13,"parents":[]},{"symbol":"M","children":[{"x":6,"y":14}],"x":6,"y":13,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":1,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":4,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":5,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":6,"y":14,"parents":[]}],"room_type":"EventRoom"}}'

class SmartPathHandlerTestCase(unittest.TestCase):

    def test_no_errors_on_basic(self):
        handler = SmartPathHandler()
        state = GameState(json.loads(INITIAL_STATE))

        self.assertTrue(handler.can_handle(state))
        self.assertEqual(["choose 0"], handler.handle(state))

    def test_with_many_options(self):
        handler = SmartPathHandler()
        state = GameState(json.loads(INITIAL_STATE))

        self.assertTrue(handler.can_handle(state))
        self.assertEqual(["choose 2"], handler.handle(state))

    def test_after_floor_0(self):
        handler = SmartPathHandler()
        state = GameState(json.loads(FLOOR_5ISH))

        self.assertTrue(handler.can_handle(state))
        self.assertEqual(["choose 1"], handler.handle(state))

if __name__ == '__main__':
    unittest.main()
