import json
import unittest

from rs.ai.requested_strike.handlers.shop_purchase_handler import ShopPurchaseHandler
from rs.machine.state import GameState

PERFECTED_STRIKE = '{"available_commands":["choose","leave","key","click","wait","state"],"ready_for_command":true,"in_game":true,"game_state":{"choice_list":["purge","perfected strike","anger","armaments","havoc","evolve","trip","gambler\u0027s brew","swift potion","strength potion"],"screen_type":"SHOP_SCREEN","screen_state":{"cards":[{"exhausts":false,"cost":2,"price":49,"name":"Perfected Strike","id":"Perfected Strike","type":"ATTACK","ethereal":false,"uuid":"f4fe2691-34d6-4199-afcd-24242d5b7571","upgrades":0,"rarity":"COMMON","has_target":true},{"exhausts":false,"cost":0,"price":50,"name":"Anger","id":"Anger","type":"ATTACK","ethereal":false,"uuid":"56584451-dc07-47c7-bc46-4d934b5a4292","upgrades":0,"rarity":"COMMON","has_target":true},{"exhausts":false,"cost":1,"price":22,"name":"Armaments","id":"Armaments","type":"SKILL","ethereal":false,"uuid":"e43410f1-a606-45dc-999c-271ea3f18902","upgrades":0,"rarity":"COMMON","has_target":false},{"exhausts":false,"cost":1,"price":54,"name":"Havoc","id":"Havoc","type":"SKILL","ethereal":false,"uuid":"32a5490e-13c4-4ff2-b366-c41086360521","upgrades":0,"rarity":"COMMON","has_target":false},{"exhausts":false,"cost":1,"price":69,"name":"Evolve","id":"Evolve","type":"POWER","ethereal":false,"uuid":"97132778-42f1-4a2f-b063-4065f0247611","upgrades":0,"rarity":"UNCOMMON","has_target":false},{"exhausts":false,"cost":0,"price":90,"name":"Trip","id":"Trip","type":"SKILL","ethereal":false,"uuid":"1139e136-de72-4a16-8aa4-965fd558ae84","upgrades":0,"rarity":"UNCOMMON","has_target":true},{"exhausts":true,"cost":0,"price":190,"name":"Secret Technique","id":"Secret Technique","type":"SKILL","ethereal":false,"uuid":"e35f4ec9-3101-46d2-be90-0937280269d4","upgrades":0,"rarity":"RARE","has_target":false}],"purge_cost":75,"potions":[{"requires_target":false,"can_use":false,"can_discard":true,"price":75,"name":"Gambler\u0027s Brew","id":"GamblersBrew"},{"requires_target":false,"can_use":false,"can_discard":true,"price":48,"name":"Swift Potion","id":"Swift Potion"},{"requires_target":false,"can_use":false,"can_discard":true,"price":52,"name":"Strength Potion","id":"Strength Potion"}],"relics":[{"price":148,"name":"Juzu Bracelet","id":"Juzu Bracelet","counter":-1},{"price":240,"name":"Meat on the Bone","id":"Meat on the Bone","counter":-1},{"price":148,"name":"The Abacus","id":"TheAbacus","counter":-1}],"purge_available":true},"seed":7780512370516821502,"deck":[{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"b973b514-0fa3-4c7d-99c8-4e888d392615","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"3dd3e8b0-7217-4e46-a1ca-da489b80845f","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"e258db38-be43-484a-9d5d-81795f314cb4","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"fc5b3055-20fd-43b5-96ab-6700857eec71","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"a268e667-4916-4c4a-bd3c-ac437b5fff9e","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"e0d7b68a-fa7a-4f5a-8145-de00854b2f72","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"e0aa4750-a05e-407c-b187-8b06a2268145","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"75a4d8ca-f664-4a3f-9d99-3322c721805f","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"3d8eba7d-3aa8-4ff6-afaa-c24bb606db69","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"cost":2,"name":"Bash+","id":"Bash","type":"ATTACK","ethereal":false,"uuid":"93f9753e-e1e1-42c9-8879-a7647bc088ef","upgrades":1,"rarity":"BASIC","has_target":true},{"exhausts":true,"cost":2,"name":"Shockwave","id":"Shockwave","type":"SKILL","ethereal":false,"uuid":"b65f00b9-8d19-4fb8-8ce0-1c5b5802e66a","upgrades":0,"rarity":"UNCOMMON","has_target":false}],"relics":[{"name":"Burning Blood","id":"Burning Blood","counter":-1}],"max_hp":80,"act_boss":"Slime Boss","gold":113,"action_phase":"WAITING_ON_USER","act":1,"screen_name":"SHOP","room_phase":"COMPLETE","is_screen_up":true,"potions":[{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"},{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"},{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"}],"current_hp":80,"floor":2,"ascension_level":0,"class":"IRONCLAD","map":[{"symbol":"M","children":[{"x":0,"y":1},{"x":1,"y":1}],"x":0,"y":0,"parents":[]},{"symbol":"M","children":[{"x":3,"y":1}],"x":2,"y":0,"parents":[]},{"symbol":"M","children":[{"x":4,"y":1}],"x":4,"y":0,"parents":[]},{"symbol":"M","children":[{"x":6,"y":1}],"x":6,"y":0,"parents":[]},{"symbol":"M","children":[{"x":0,"y":2}],"x":0,"y":1,"parents":[]},{"symbol":"$","children":[{"x":1,"y":2},{"x":2,"y":2}],"x":1,"y":1,"parents":[]},{"symbol":"$","children":[{"x":3,"y":2}],"x":3,"y":1,"parents":[]},{"symbol":"M","children":[{"x":4,"y":2}],"x":4,"y":1,"parents":[]},{"symbol":"M","children":[{"x":6,"y":2}],"x":6,"y":1,"parents":[]},{"symbol":"M","children":[{"x":1,"y":3}],"x":0,"y":2,"parents":[]},{"symbol":"M","children":[{"x":1,"y":3}],"x":1,"y":2,"parents":[]},{"symbol":"?","children":[{"x":1,"y":3}],"x":2,"y":2,"parents":[]},{"symbol":"M","children":[{"x":2,"y":3}],"x":3,"y":2,"parents":[]},{"symbol":"?","children":[{"x":3,"y":3}],"x":4,"y":2,"parents":[]},{"symbol":"M","children":[{"x":6,"y":3}],"x":6,"y":2,"parents":[]},{"symbol":"$","children":[{"x":1,"y":4},{"x":2,"y":4}],"x":1,"y":3,"parents":[]},{"symbol":"M","children":[{"x":2,"y":4}],"x":2,"y":3,"parents":[]},{"symbol":"M","children":[{"x":2,"y":4}],"x":3,"y":3,"parents":[]},{"symbol":"M","children":[{"x":6,"y":4}],"x":6,"y":3,"parents":[]},{"symbol":"?","children":[{"x":1,"y":5}],"x":1,"y":4,"parents":[]},{"symbol":"M","children":[{"x":1,"y":5},{"x":3,"y":5}],"x":2,"y":4,"parents":[]},{"symbol":"?","children":[{"x":5,"y":5}],"x":6,"y":4,"parents":[]},{"symbol":"E","children":[{"x":1,"y":6},{"x":2,"y":6}],"x":1,"y":5,"parents":[]},{"symbol":"R","children":[{"x":2,"y":6},{"x":3,"y":6},{"x":4,"y":6}],"x":3,"y":5,"parents":[]},{"symbol":"E","children":[{"x":5,"y":6}],"x":5,"y":5,"parents":[]},{"symbol":"R","children":[{"x":0,"y":7}],"x":1,"y":6,"parents":[]},{"symbol":"?","children":[{"x":1,"y":7},{"x":3,"y":7}],"x":2,"y":6,"parents":[]},{"symbol":"E","children":[{"x":3,"y":7}],"x":3,"y":6,"parents":[]},{"symbol":"M","children":[{"x":4,"y":7}],"x":4,"y":6,"parents":[]},{"symbol":"R","children":[{"x":4,"y":7}],"x":5,"y":6,"parents":[]},{"symbol":"E","children":[{"x":1,"y":8}],"x":0,"y":7,"parents":[]},{"symbol":"R","children":[{"x":1,"y":8}],"x":1,"y":7,"parents":[]},{"symbol":"M","children":[{"x":3,"y":8},{"x":4,"y":8}],"x":3,"y":7,"parents":[]},{"symbol":"M","children":[{"x":4,"y":8},{"x":5,"y":8}],"x":4,"y":7,"parents":[]},{"symbol":"T","children":[{"x":2,"y":9}],"x":1,"y":8,"parents":[]},{"symbol":"T","children":[{"x":3,"y":9}],"x":3,"y":8,"parents":[]},{"symbol":"T","children":[{"x":3,"y":9},{"x":4,"y":9}],"x":4,"y":8,"parents":[]},{"symbol":"T","children":[{"x":6,"y":9}],"x":5,"y":8,"parents":[]},{"symbol":"M","children":[{"x":1,"y":10},{"x":3,"y":10}],"x":2,"y":9,"parents":[]},{"symbol":"R","children":[{"x":3,"y":10},{"x":4,"y":10}],"x":3,"y":9,"parents":[]},{"symbol":"M","children":[{"x":4,"y":10}],"x":4,"y":9,"parents":[]},{"symbol":"?","children":[{"x":5,"y":10}],"x":6,"y":9,"parents":[]},{"symbol":"R","children":[{"x":1,"y":11}],"x":1,"y":10,"parents":[]},{"symbol":"?","children":[{"x":3,"y":11}],"x":3,"y":10,"parents":[]},{"symbol":"M","children":[{"x":3,"y":11},{"x":4,"y":11}],"x":4,"y":10,"parents":[]},{"symbol":"?","children":[{"x":5,"y":11}],"x":5,"y":10,"parents":[]},{"symbol":"?","children":[{"x":1,"y":12}],"x":1,"y":11,"parents":[]},{"symbol":"?","children":[{"x":2,"y":12},{"x":3,"y":12}],"x":3,"y":11,"parents":[]},{"symbol":"R","children":[{"x":3,"y":12}],"x":4,"y":11,"parents":[]},{"symbol":"?","children":[{"x":4,"y":12}],"x":5,"y":11,"parents":[]},{"symbol":"?","children":[{"x":0,"y":13}],"x":1,"y":12,"parents":[]},{"symbol":"M","children":[{"x":2,"y":13},{"x":3,"y":13}],"x":2,"y":12,"parents":[]},{"symbol":"E","children":[{"x":4,"y":13}],"x":3,"y":12,"parents":[]},{"symbol":"M","children":[{"x":4,"y":13}],"x":4,"y":12,"parents":[]},{"symbol":"?","children":[{"x":1,"y":14}],"x":0,"y":13,"parents":[]},{"symbol":"M","children":[{"x":1,"y":14}],"x":2,"y":13,"parents":[]},{"symbol":"M","children":[{"x":3,"y":14}],"x":3,"y":13,"parents":[]},{"symbol":"M","children":[{"x":3,"y":14},{"x":5,"y":14}],"x":4,"y":13,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":1,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":3,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":5,"y":14,"parents":[]}],"room_type":"ShopRoom"}}'
ALREADY_PURGED = '{"available_commands":["choose","potion","leave","key","click","wait","state"],"ready_for_command":true,"in_game":true,"game_state":{"choice_list":["feed","blood for blood","burning pact","limit break","dark embrace","bandage up","sadistic nature","prismatic shard","liquid bronze","weak potion","flex potion"],"screen_type":"SHOP_SCREEN","screen_state":{"cards":[{"exhausts":true,"cost":1,"price":144,"name":"Feed","id":"Feed","type":"ATTACK","ethereal":false,"uuid":"adfdca1e-a6ef-4a59-9f24-1689497c1933","upgrades":0,"rarity":"RARE","has_target":true},{"exhausts":false,"cost":4,"price":34,"name":"Blood for Blood","id":"Blood for Blood","type":"ATTACK","ethereal":false,"uuid":"dd687c5c-06df-45d3-a238-6e2a9f21240c","upgrades":0,"rarity":"UNCOMMON","has_target":true},{"exhausts":false,"cost":1,"price":73,"name":"Burning Pact","id":"Burning Pact","type":"SKILL","ethereal":false,"uuid":"8b731128-2951-4a14-a805-142ae0942db0","upgrades":0,"rarity":"UNCOMMON","has_target":false},{"exhausts":true,"cost":1,"price":149,"name":"Limit Break","id":"Limit Break","type":"SKILL","ethereal":false,"uuid":"c6471dc5-1093-4a72-9d97-4edf39b54358","upgrades":0,"rarity":"RARE","has_target":false},{"exhausts":false,"cost":2,"price":76,"name":"Dark Embrace","id":"Dark Embrace","type":"POWER","ethereal":false,"uuid":"ea8be9ca-5c66-49b0-b8d6-7cf207ba711c","upgrades":0,"rarity":"UNCOMMON","has_target":false},{"exhausts":true,"cost":0,"price":81,"name":"Bandage Up","id":"Bandage Up","type":"SKILL","ethereal":false,"uuid":"ac839e62-b725-4b93-aade-97d5aa8a855f","upgrades":0,"rarity":"UNCOMMON","has_target":false},{"exhausts":false,"cost":0,"price":178,"name":"Sadistic Nature","id":"Sadistic Nature","type":"POWER","ethereal":false,"uuid":"9b7b3d3d-e6bf-4b8f-8282-91aa51448f74","upgrades":0,"rarity":"RARE","has_target":false}],"purge_cost":100,"potions":[{"requires_target":false,"can_use":false,"can_discard":true,"price":78,"name":"Liquid Bronze","id":"LiquidBronze"},{"requires_target":true,"can_use":false,"can_discard":true,"price":50,"name":"Weak Potion","id":"Weak Potion"},{"requires_target":false,"can_use":false,"can_discard":true,"price":51,"name":"Flex Potion","id":"SteroidPotion"}],"relics":[{"price":257,"name":"Toxic Egg","id":"Toxic Egg 2","counter":-1},{"price":251,"name":"Pear","id":"Pear","counter":-1},{"price":153,"name":"Prismatic Shard","id":"PrismaticShard","counter":-1}],"purge_available":false},"seed":8384104047375930385,"deck":[{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"8e88339c-62ae-422d-9479-9d0733d0d98f","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"ae292d22-75e2-466a-8ad3-b390f42dd07e","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"94b30cbf-5c26-46eb-829e-cd7b24c8da2f","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"21b2eadc-11f4-454a-ac8d-016f1cb06645","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"4028eb66-5cf6-41b9-b6b3-6df152768960","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"cbf1e7dd-5305-486e-b397-312af60aa124","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"789031bd-ba4f-4263-a4b9-075c7a2d8159","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"57ed69fa-9b32-4bab-98ab-ca4925a5313c","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"cost":2,"name":"Bash","id":"Bash","type":"ATTACK","ethereal":false,"uuid":"98ad0c55-4fe6-481b-a9bb-720fe43204f8","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Twin Strike","id":"Twin Strike","type":"ATTACK","ethereal":false,"uuid":"3b204d71-b598-450a-8627-56709030d936","upgrades":0,"rarity":"COMMON","has_target":true},{"exhausts":false,"cost":1,"name":"Twin Strike","id":"Twin Strike","type":"ATTACK","ethereal":false,"uuid":"b6d6e299-5772-4ef0-9d4b-7f4b9b3646e2","upgrades":0,"rarity":"COMMON","has_target":true},{"exhausts":false,"cost":1,"name":"Thunderclap","id":"Thunderclap","type":"ATTACK","ethereal":false,"uuid":"e17213f1-cde7-45f1-89b6-414e6e8f2a8e","upgrades":0,"rarity":"COMMON","has_target":false},{"exhausts":true,"cost":2,"name":"Reaper","id":"Reaper","type":"ATTACK","ethereal":false,"uuid":"a35275b3-2b06-469b-b006-616a1cdafe4f","upgrades":0,"rarity":"RARE","has_target":false}],"relics":[{"name":"Burning Blood","id":"Burning Blood","counter":-1},{"name":"Neow\u0027s Lament","id":"NeowsBlessing","counter":-2},{"name":"Peace Pipe","id":"Peace Pipe","counter":-1}],"max_hp":80,"act_boss":"Hexaghost","gold":206,"action_phase":"WAITING_ON_USER","act":1,"screen_name":"SHOP","room_phase":"COMPLETE","is_screen_up":true,"potions":[{"requires_target":true,"can_use":false,"can_discard":true,"name":"Fear Potion","id":"FearPotion"},{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"},{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"}],"current_hp":37,"floor":7,"ascension_level":0,"class":"IRONCLAD","map":[{"symbol":"M","children":[{"x":0,"y":1}],"x":0,"y":0,"parents":[]},{"symbol":"M","children":[{"x":1,"y":1},{"x":2,"y":1},{"x":3,"y":1}],"x":2,"y":0,"parents":[]},{"symbol":"M","children":[{"x":5,"y":1}],"x":4,"y":0,"parents":[]},{"symbol":"M","children":[{"x":0,"y":2}],"x":0,"y":1,"parents":[]},{"symbol":"M","children":[{"x":0,"y":2}],"x":1,"y":1,"parents":[]},{"symbol":"$","children":[{"x":1,"y":2}],"x":2,"y":1,"parents":[]},{"symbol":"?","children":[{"x":3,"y":2},{"x":4,"y":2}],"x":3,"y":1,"parents":[]},{"symbol":"M","children":[{"x":6,"y":2}],"x":5,"y":1,"parents":[]},{"symbol":"M","children":[{"x":0,"y":3}],"x":0,"y":2,"parents":[]},{"symbol":"M","children":[{"x":1,"y":3}],"x":1,"y":2,"parents":[]},{"symbol":"M","children":[{"x":2,"y":3}],"x":3,"y":2,"parents":[]},{"symbol":"?","children":[{"x":4,"y":3}],"x":4,"y":2,"parents":[]},{"symbol":"M","children":[{"x":5,"y":3}],"x":6,"y":2,"parents":[]},{"symbol":"M","children":[{"x":0,"y":4},{"x":1,"y":4}],"x":0,"y":3,"parents":[]},{"symbol":"M","children":[{"x":2,"y":4}],"x":1,"y":3,"parents":[]},{"symbol":"M","children":[{"x":2,"y":4}],"x":2,"y":3,"parents":[]},{"symbol":"M","children":[{"x":4,"y":4}],"x":4,"y":3,"parents":[]},{"symbol":"M","children":[{"x":6,"y":4}],"x":5,"y":3,"parents":[]},{"symbol":"M","children":[{"x":0,"y":5}],"x":0,"y":4,"parents":[]},{"symbol":"?","children":[{"x":2,"y":5}],"x":1,"y":4,"parents":[]},{"symbol":"M","children":[{"x":2,"y":5}],"x":2,"y":4,"parents":[]},{"symbol":"M","children":[{"x":3,"y":5}],"x":4,"y":4,"parents":[]},{"symbol":"M","children":[{"x":5,"y":5}],"x":6,"y":4,"parents":[]},{"symbol":"R","children":[{"x":1,"y":6}],"x":0,"y":5,"parents":[]},{"symbol":"E","children":[{"x":1,"y":6},{"x":2,"y":6}],"x":2,"y":5,"parents":[]},{"symbol":"E","children":[{"x":2,"y":6}],"x":3,"y":5,"parents":[]},{"symbol":"E","children":[{"x":4,"y":6}],"x":5,"y":5,"parents":[]},{"symbol":"$","children":[{"x":0,"y":7},{"x":1,"y":7}],"x":1,"y":6,"parents":[]},{"symbol":"R","children":[{"x":2,"y":7},{"x":3,"y":7}],"x":2,"y":6,"parents":[]},{"symbol":"M","children":[{"x":5,"y":7}],"x":4,"y":6,"parents":[]},{"symbol":"E","children":[{"x":0,"y":8}],"x":0,"y":7,"parents":[]},{"symbol":"?","children":[{"x":1,"y":8}],"x":1,"y":7,"parents":[]},{"symbol":"M","children":[{"x":1,"y":8}],"x":2,"y":7,"parents":[]},{"symbol":"?","children":[{"x":2,"y":8}],"x":3,"y":7,"parents":[]},{"symbol":"R","children":[{"x":4,"y":8}],"x":5,"y":7,"parents":[]},{"symbol":"T","children":[{"x":0,"y":9}],"x":0,"y":8,"parents":[]},{"symbol":"T","children":[{"x":0,"y":9},{"x":1,"y":9}],"x":1,"y":8,"parents":[]},{"symbol":"T","children":[{"x":3,"y":9}],"x":2,"y":8,"parents":[]},{"symbol":"T","children":[{"x":4,"y":9}],"x":4,"y":8,"parents":[]},{"symbol":"M","children":[{"x":1,"y":10}],"x":0,"y":9,"parents":[]},{"symbol":"?","children":[{"x":2,"y":10}],"x":1,"y":9,"parents":[]},{"symbol":"M","children":[{"x":3,"y":10}],"x":3,"y":9,"parents":[]},{"symbol":"M","children":[{"x":3,"y":10}],"x":4,"y":9,"parents":[]},{"symbol":"?","children":[{"x":0,"y":11},{"x":2,"y":11}],"x":1,"y":10,"parents":[]},{"symbol":"M","children":[{"x":3,"y":11}],"x":2,"y":10,"parents":[]},{"symbol":"?","children":[{"x":3,"y":11}],"x":3,"y":10,"parents":[]},{"symbol":"?","children":[{"x":0,"y":12}],"x":0,"y":11,"parents":[]},{"symbol":"R","children":[{"x":1,"y":12},{"x":2,"y":12}],"x":2,"y":11,"parents":[]},{"symbol":"?","children":[{"x":2,"y":12}],"x":3,"y":11,"parents":[]},{"symbol":"R","children":[{"x":0,"y":13}],"x":0,"y":12,"parents":[]},{"symbol":"$","children":[{"x":1,"y":13}],"x":1,"y":12,"parents":[]},{"symbol":"M","children":[{"x":2,"y":13},{"x":3,"y":13}],"x":2,"y":12,"parents":[]},{"symbol":"?","children":[{"x":0,"y":14}],"x":0,"y":13,"parents":[]},{"symbol":"?","children":[{"x":1,"y":14}],"x":1,"y":13,"parents":[]},{"symbol":"M","children":[{"x":2,"y":14},{"x":3,"y":14}],"x":2,"y":13,"parents":[]},{"symbol":"M","children":[{"x":3,"y":14}],"x":3,"y":13,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":0,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":1,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":2,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":3,"y":14,"parents":[]}],"room_type":"ShopRoom"}}'
CANT_BUY_ANYTHING = '{"available_commands":["leave","key","click","wait","state"],"ready_for_command":true,"in_game":true,"game_state":{"screen_type":"SHOP_SCREEN","screen_state":{"cards":[{"exhausts":false,"cost":2,"price":38,"name":"Sever Soul","id":"Sever Soul","type":"ATTACK","ethereal":false,"uuid":"58226ec9-e35d-47dc-8991-b1a60e750862","upgrades":0,"rarity":"UNCOMMON","has_target":true},{"exhausts":false,"cost":-1,"price":81,"name":"Whirlwind","id":"Whirlwind","type":"ATTACK","ethereal":false,"uuid":"872996aa-29df-4587-a830-0ab377875be9","upgrades":0,"rarity":"UNCOMMON","has_target":false},{"exhausts":false,"cost":0,"price":53,"name":"Flex","id":"Flex","type":"SKILL","ethereal":false,"uuid":"20d0f99c-7e05-46d0-9fda-e29626a4d3dd","upgrades":0,"rarity":"COMMON","has_target":false},{"exhausts":false,"cost":1,"price":46,"name":"True Grit","id":"True Grit","type":"SKILL","ethereal":false,"uuid":"ee5bbfaa-7f8a-4611-8084-f3bbb808b1ad","upgrades":0,"rarity":"COMMON","has_target":false},{"exhausts":false,"cost":1,"price":73,"name":"Metallicize","id":"Metallicize","type":"POWER","ethereal":false,"uuid":"d34fd06f-1d11-4e00-aade-d89096b3bbba","upgrades":0,"rarity":"UNCOMMON","has_target":false},{"exhausts":false,"cost":0,"price":84,"name":"Finesse","id":"Finesse","type":"SKILL","ethereal":false,"uuid":"15b4c79d-bc46-4f56-bd68-4ed572a698f1","upgrades":0,"rarity":"UNCOMMON","has_target":false},{"exhausts":true,"cost":0,"price":177,"name":"Thinking Ahead","id":"Thinking Ahead","type":"SKILL","ethereal":false,"uuid":"2f327542-582e-461a-9835-c317db2fdff8","upgrades":0,"rarity":"RARE","has_target":false}],"purge_cost":100,"potions":[{"requires_target":false,"can_use":false,"can_discard":true,"price":49,"name":"Swift Potion","id":"Swift Potion"},{"requires_target":true,"can_use":false,"can_discard":true,"price":49,"name":"Weak Potion","id":"Weak Potion"},{"requires_target":false,"can_use":false,"can_discard":true,"price":97,"name":"Snecko Oil","id":"SneckoOil"}],"relics":[{"price":143,"name":"Meal Ticket","id":"MealTicket","counter":-1},{"price":145,"name":"Anchor","id":"Anchor","counter":-1},{"price":155,"name":"Medical Kit","id":"Medical Kit","counter":-1}],"purge_available":false},"seed":8908759309504903802,"deck":[{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"18033447-b3d0-4b77-ac60-bbe3e7757018","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"e592c9db-07b5-4efd-9886-7911e0cfaa8b","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"b166932f-319c-4f80-8173-a1be17820db6","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"6e9c4779-f0af-4e50-a1f0-f4d376a16aad","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Strike","id":"Strike_R","type":"ATTACK","ethereal":false,"uuid":"fc2cdcb6-ec1e-4a50-91ef-2fc71a2ebe58","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":1,"name":"Defend","id":"Defend_R","type":"SKILL","ethereal":false,"uuid":"1802dbe3-20ad-42e8-a433-eb48ff7aa1d2","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"cost":2,"name":"Bash","id":"Bash","type":"ATTACK","ethereal":false,"uuid":"7de49a14-76a8-4a54-a8a4-9d71fa024072","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"cost":2,"name":"Carnage","id":"Carnage","type":"ATTACK","ethereal":true,"uuid":"2511924b-085a-4cb7-8a45-176b5987386b","upgrades":0,"rarity":"UNCOMMON","has_target":true},{"exhausts":false,"cost":1,"name":"Thunderclap","id":"Thunderclap","type":"ATTACK","ethereal":false,"uuid":"e7a80115-46ee-4f4c-a64c-9b540067f68d","upgrades":0,"rarity":"COMMON","has_target":false}],"relics":[{"name":"Burning Blood","id":"Burning Blood","counter":-1}],"max_hp":80,"act_boss":"The Guardian","gold":36,"action_phase":"WAITING_ON_USER","act":1,"screen_name":"SHOP","room_phase":"COMPLETE","is_screen_up":true,"potions":[{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"},{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"},{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"}],"current_hp":73,"floor":3,"ascension_level":0,"class":"IRONCLAD","map":[{"symbol":"M","children":[{"x":1,"y":1}],"x":0,"y":0,"parents":[]},{"symbol":"M","children":[{"x":3,"y":1}],"x":3,"y":0,"parents":[]},{"symbol":"M","children":[{"x":5,"y":1},{"x":6,"y":1}],"x":6,"y":0,"parents":[]},{"symbol":"?","children":[{"x":0,"y":2},{"x":2,"y":2}],"x":1,"y":1,"parents":[]},{"symbol":"M","children":[{"x":4,"y":2}],"x":3,"y":1,"parents":[]},{"symbol":"M","children":[{"x":5,"y":2}],"x":5,"y":1,"parents":[]},{"symbol":"?","children":[{"x":6,"y":2}],"x":6,"y":1,"parents":[]},{"symbol":"M","children":[{"x":0,"y":3}],"x":0,"y":2,"parents":[]},{"symbol":"?","children":[{"x":2,"y":3}],"x":2,"y":2,"parents":[]},{"symbol":"M","children":[{"x":3,"y":3},{"x":5,"y":3}],"x":4,"y":2,"parents":[]},{"symbol":"M","children":[{"x":6,"y":3}],"x":5,"y":2,"parents":[]},{"symbol":"$","children":[{"x":6,"y":3}],"x":6,"y":2,"parents":[]},{"symbol":"M","children":[{"x":0,"y":4}],"x":0,"y":3,"parents":[]},{"symbol":"M","children":[{"x":1,"y":4}],"x":2,"y":3,"parents":[]},{"symbol":"?","children":[{"x":2,"y":4}],"x":3,"y":3,"parents":[]},{"symbol":"M","children":[{"x":6,"y":4}],"x":5,"y":3,"parents":[]},{"symbol":"?","children":[{"x":6,"y":4}],"x":6,"y":3,"parents":[]},{"symbol":"M","children":[{"x":0,"y":5}],"x":0,"y":4,"parents":[]},{"symbol":"M","children":[{"x":1,"y":5}],"x":1,"y":4,"parents":[]},{"symbol":"M","children":[{"x":2,"y":5}],"x":2,"y":4,"parents":[]},{"symbol":"?","children":[{"x":5,"y":5},{"x":6,"y":5}],"x":6,"y":4,"parents":[]},{"symbol":"R","children":[{"x":0,"y":6}],"x":0,"y":5,"parents":[]},{"symbol":"R","children":[{"x":2,"y":6}],"x":1,"y":5,"parents":[]},{"symbol":"M","children":[{"x":2,"y":6}],"x":2,"y":5,"parents":[]},{"symbol":"E","children":[{"x":5,"y":6}],"x":5,"y":5,"parents":[]},{"symbol":"M","children":[{"x":5,"y":6},{"x":6,"y":6}],"x":6,"y":5,"parents":[]},{"symbol":"?","children":[{"x":1,"y":7}],"x":0,"y":6,"parents":[]},{"symbol":"E","children":[{"x":1,"y":7},{"x":3,"y":7}],"x":2,"y":6,"parents":[]},{"symbol":"R","children":[{"x":5,"y":7},{"x":6,"y":7}],"x":5,"y":6,"parents":[]},{"symbol":"?","children":[{"x":6,"y":7}],"x":6,"y":6,"parents":[]},{"symbol":"M","children":[{"x":0,"y":8},{"x":2,"y":8}],"x":1,"y":7,"parents":[]},{"symbol":"$","children":[{"x":3,"y":8}],"x":3,"y":7,"parents":[]},{"symbol":"M","children":[{"x":6,"y":8}],"x":5,"y":7,"parents":[]},{"symbol":"E","children":[{"x":6,"y":8}],"x":6,"y":7,"parents":[]},{"symbol":"T","children":[{"x":0,"y":9}],"x":0,"y":8,"parents":[]},{"symbol":"T","children":[{"x":3,"y":9}],"x":2,"y":8,"parents":[]},{"symbol":"T","children":[{"x":3,"y":9}],"x":3,"y":8,"parents":[]},{"symbol":"T","children":[{"x":5,"y":9},{"x":6,"y":9}],"x":6,"y":8,"parents":[]},{"symbol":"M","children":[{"x":0,"y":10}],"x":0,"y":9,"parents":[]},{"symbol":"M","children":[{"x":2,"y":10}],"x":3,"y":9,"parents":[]},{"symbol":"M","children":[{"x":4,"y":10}],"x":5,"y":9,"parents":[]},{"symbol":"E","children":[{"x":5,"y":10},{"x":6,"y":10}],"x":6,"y":9,"parents":[]},{"symbol":"M","children":[{"x":0,"y":11}],"x":0,"y":10,"parents":[]},{"symbol":"M","children":[{"x":3,"y":11}],"x":2,"y":10,"parents":[]},{"symbol":"?","children":[{"x":3,"y":11}],"x":4,"y":10,"parents":[]},{"symbol":"M","children":[{"x":4,"y":11}],"x":5,"y":10,"parents":[]},{"symbol":"R","children":[{"x":6,"y":11}],"x":6,"y":10,"parents":[]},{"symbol":"M","children":[{"x":0,"y":12}],"x":0,"y":11,"parents":[]},{"symbol":"?","children":[{"x":2,"y":12},{"x":3,"y":12}],"x":3,"y":11,"parents":[]},{"symbol":"?","children":[{"x":5,"y":12}],"x":4,"y":11,"parents":[]},{"symbol":"M","children":[{"x":6,"y":12}],"x":6,"y":11,"parents":[]},{"symbol":"R","children":[{"x":0,"y":13}],"x":0,"y":12,"parents":[]},{"symbol":"?","children":[{"x":3,"y":13}],"x":2,"y":12,"parents":[]},{"symbol":"R","children":[{"x":4,"y":13}],"x":3,"y":12,"parents":[]},{"symbol":"M","children":[{"x":5,"y":13}],"x":5,"y":12,"parents":[]},{"symbol":"$","children":[{"x":6,"y":13}],"x":6,"y":12,"parents":[]},{"symbol":"E","children":[{"x":0,"y":14}],"x":0,"y":13,"parents":[]},{"symbol":"M","children":[{"x":2,"y":14},{"x":3,"y":14}],"x":3,"y":13,"parents":[]},{"symbol":"M","children":[{"x":5,"y":14}],"x":4,"y":13,"parents":[]},{"symbol":"?","children":[{"x":5,"y":14}],"x":5,"y":13,"parents":[]},{"symbol":"M","children":[{"x":6,"y":14}],"x":6,"y":13,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":0,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":2,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":3,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":5,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":6,"y":14,"parents":[]}],"room_type":"ShopRoom"}}'

class ShopPurchaseHandlerTestCase(unittest.TestCase):
    def test_buy_perfected_strike(self):
        handler = ShopPurchaseHandler()
        state = GameState(json.loads(PERFECTED_STRIKE))

        self.assertTrue(handler.can_handle(state))
        self.assertEqual(["choose 1", "wait 30"], handler.handle(state))

    def test_handles_purge_already_used(self):
        handler = ShopPurchaseHandler()
        state = GameState(json.loads(ALREADY_PURGED))

        self.assertTrue(handler.can_handle(state))
        self.assertEqual(["return", "proceed"], handler.handle(state))

    def test_cant_afford_anything(self):
        handler = ShopPurchaseHandler()
        state = GameState(json.loads(CANT_BUY_ANYTHING))

        self.assertTrue(handler.can_handle(state))
        self.assertEqual(["return", "proceed"], handler.handle(state))


if __name__ == '__main__':
    unittest.main()
